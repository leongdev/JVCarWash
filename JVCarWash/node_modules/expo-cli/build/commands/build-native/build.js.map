{"version":3,"sources":["../../../src/commands/build-native/build.ts"],"names":["BuildStatus","createBuilderContextAsync","projectDir","eas","user","UserManager","ensureLoggedInAsync","exp","accountName","owner","username","projectName","slug","startBuildAsync","client","builder","projectId","tarPath","path","join","os","tmpdir","ensureCredentialsAsync","fileSize","archiveUrl","UploadType","TURTLE_PROJECT_SOURCES","job","prepareJobAsync","buildId","postAsync","fs","remove","waitForBuildEndAsync","ctx","buildIds","timeoutSec","intervalSec","ApiV2","clientForUser","spinner","start","time","Date","getTime","endTime","buildInfo","Promise","all","map","getAsync","err","length","status","FINISHED","succeed","IN_QUEUE","text","IN_PROGRESS","ERRORED","fail","Error","warn","filter","build","includes","inQueue","inProgress","errored","finished","unknownState","chalk","red","green","i"],"mappings":"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","sourcesContent":["import { Job, Platform } from '@expo/build-tools';\nimport { ExpoConfig, getConfig } from '@expo/config';\nimport { ApiV2, User, UserManager } from '@expo/xdl';\nimport chalk from 'chalk';\nimport delayAsync from 'delay-async';\nimport fs from 'fs-extra';\nimport ora from 'ora';\nimport os from 'os';\nimport path from 'path';\nimport { v4 as uuidv4 } from 'uuid';\n\nimport { EasConfig } from '../../easJson';\nimport log from '../../log';\nimport { UploadType, uploadAsync } from '../../uploads';\nimport { createProgressTracker } from '../utils/progress';\nimport { makeProjectTarballAsync } from './utils';\n\nexport enum BuildStatus {\n  IN_QUEUE = 'in-queue',\n  IN_PROGRESS = 'in-progress',\n  ERRORED = 'errored',\n  FINISHED = 'finished',\n}\n\nexport interface BuildInfo {\n  id: string;\n  status: BuildStatus;\n  platform: Platform;\n  createdAt: string;\n  artifacts?: BuildArtifacts;\n}\n\ninterface BuildArtifacts {\n  buildUrl?: string;\n  logsUrl: string;\n}\n\nexport interface BuilderContext {\n  projectDir: string;\n  eas: EasConfig;\n  user: User;\n  accountName: string;\n  projectName: string;\n  exp: ExpoConfig;\n}\n\nexport interface Builder {\n  ctx: BuilderContext;\n  ensureCredentialsAsync(): Promise<void>;\n  prepareJobAsync(archiveUrl: string): Promise<Job>;\n}\n\nexport async function createBuilderContextAsync(\n  projectDir: string,\n  eas: EasConfig\n): Promise<BuilderContext> {\n  const user: User = await UserManager.ensureLoggedInAsync();\n  const { exp } = getConfig(projectDir);\n  const accountName = exp.owner || user.username;\n  const projectName = exp.slug;\n\n  return {\n    eas,\n    projectDir,\n    user,\n    accountName,\n    projectName,\n    exp,\n  };\n}\n\nexport async function startBuildAsync(\n  client: ApiV2,\n  builder: Builder,\n  projectId: string\n): Promise<string> {\n  const tarPath = path.join(os.tmpdir(), `${uuidv4()}.tar.gz`);\n  try {\n    await builder.ensureCredentialsAsync();\n\n    const fileSize = await makeProjectTarballAsync(tarPath);\n\n    log('Uploading project to AWS S3');\n    const archiveUrl = await uploadAsync(\n      UploadType.TURTLE_PROJECT_SOURCES,\n      tarPath,\n      createProgressTracker(fileSize)\n    );\n\n    const job = await builder.prepareJobAsync(archiveUrl);\n    log('Starting build');\n    const { buildId } = await client.postAsync(`projects/${projectId}/builds`, {\n      job: job as any,\n    });\n    return buildId;\n  } finally {\n    await fs.remove(tarPath);\n  }\n}\n\nexport async function waitForBuildEndAsync(\n  ctx: BuilderContext,\n  projectId: string,\n  buildIds: string[],\n  { timeoutSec = 1800, intervalSec = 30 } = {}\n): Promise<(BuildInfo | null)[]> {\n  const client = ApiV2.clientForUser(ctx.user);\n  log('Waiting for build to complete. You can press Ctrl+C to exit.');\n  const spinner = ora().start();\n  let time = new Date().getTime();\n  const endTime = time + timeoutSec * 1000;\n  while (time <= endTime) {\n    const buildInfo: (BuildInfo | null)[] = await Promise.all(\n      buildIds.map(buildId => {\n        try {\n          return client.getAsync(`projects/${projectId}/builds/${buildId}`);\n        } catch (err) {\n          return null;\n        }\n      })\n    );\n    if (buildInfo.length === 1) {\n      switch (buildInfo[0]?.status) {\n        case BuildStatus.FINISHED:\n          spinner.succeed('Build finished.');\n          return buildInfo;\n        case BuildStatus.IN_QUEUE:\n          spinner.text = 'Build queued...';\n          break;\n        case BuildStatus.IN_PROGRESS:\n          spinner.text = 'Build in progress...';\n          break;\n        case BuildStatus.ERRORED:\n          spinner.fail('Build failed.');\n          throw new Error(`Standalone build failed!`);\n        default:\n          spinner.warn('Unknown status.');\n          throw new Error(`Unknown status: ${buildInfo} - aborting!`);\n      }\n    } else {\n      if (\n        buildInfo.filter(build => build?.status === BuildStatus.FINISHED).length ===\n        buildInfo.length\n      ) {\n        spinner.succeed('All build have finished.');\n        return buildInfo;\n      } else if (\n        buildInfo.filter(build =>\n          build?.status ? [BuildStatus.FINISHED, BuildStatus.ERRORED].includes(build.status) : false\n        ).length === buildInfo.length\n      ) {\n        spinner.fail('Some of the builds failed.');\n        return buildInfo;\n      } else {\n        const inQueue = buildInfo.filter(build => build?.status === BuildStatus.IN_QUEUE).length;\n        const inProgress = buildInfo.filter(build => build?.status === BuildStatus.IN_PROGRESS)\n          .length;\n        const errored = buildInfo.filter(build => build?.status === BuildStatus.ERRORED).length;\n        const finished = buildInfo.filter(build => build?.status === BuildStatus.FINISHED).length;\n        const unknownState = buildInfo.length - inQueue - inProgress - errored - finished;\n        spinner.text = [\n          inQueue && `Builds in queue: ${inQueue}`,\n          inProgress && `Builds in progress: ${inProgress}`,\n          errored && chalk.red(`Builds failed: ${errored}`),\n          finished && chalk.green(`Builds finished: ${finished}`),\n          unknownState && chalk.red(`Builds in unknown state: ${unknownState}`),\n        ]\n          .filter(i => i)\n          .join('\\t');\n      }\n    }\n    time = new Date().getTime();\n    await delayAsync(intervalSec * 1000);\n  }\n  spinner.warn('Timed out.');\n  throw new Error(\n    'Timeout reached! It is taking longer than expected to finish the build, aborting...'\n  );\n}\n"],"file":"build.js"}