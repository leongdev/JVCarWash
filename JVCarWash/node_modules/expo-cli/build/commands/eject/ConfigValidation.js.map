{"version":3,"sources":["../../../src/commands/eject/ConfigValidation.ts"],"names":["noBundleIdMessage","noPackageMessage","validateBundleId","value","test","validatePackage","getOrPromptForBundleIdentifier","projectRoot","exp","skipSDKVersionRequirement","currentBundleId","ios","bundleIdentifier","log","chalk","red","process","exit","recommendedBundleId","android","package","username","owner","UserManager","getCurrentUsernameAsync","possibleId","slug","addNewLineIfNone","bold","dim","newLine","name","default","message","validate","nonInteractiveHelp","attemptModification","getOrPromptForPackage","currentPackage","recommendedPackage","split","join","packageName","edits","exactEdits","modification","type","warnAboutConfigAndExit","logNoConfig","yellow","notifyAboutManualConfigEdits","cyan","JSON","stringify"],"mappings":"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","sourcesContent":["import { ExpoConfig, getConfig, modifyConfigAsync } from '@expo/config';\nimport { UserManager } from '@expo/xdl';\n\nimport log from '../../log';\nimport prompt from '../../prompt';\nimport { learnMore } from '../utils/TerminalLink';\n\nconst noBundleIdMessage = `Your project must have a \\`bundleIdentifier\\` set in the Expo config (app.json or app.config.js).\\nSee https://expo.fyi/bundle-identifier`;\nconst noPackageMessage = `Your project must have a \\`package\\` set in the Expo config (app.json or app.config.js).\\nSee https://expo.fyi/android-package`;\n\nfunction validateBundleId(value: string): boolean {\n  return /^[a-zA-Z][a-zA-Z0-9\\-.]+$/.test(value);\n}\n\nfunction validatePackage(value: string): boolean {\n  return /^[a-zA-Z][a-zA-Z0-9_]*(\\.[a-zA-Z][a-zA-Z0-9_]*)+$/.test(value);\n}\n\nexport async function getOrPromptForBundleIdentifier(projectRoot: string): Promise<string> {\n  const { exp } = getConfig(projectRoot, { skipSDKVersionRequirement: true });\n\n  const currentBundleId = exp.ios?.bundleIdentifier;\n  if (currentBundleId) {\n    if (validateBundleId(currentBundleId)) {\n      return currentBundleId;\n    }\n\n    log(\n      log.chalk.red(\n        `The ios.bundleIdentifier defined in your Expo config is not formatted properly. Only alphanumeric characters, '.', '-', and '_' are allowed, and each '.' must be followed by a letter.`\n      )\n    );\n\n    process.exit(1);\n  }\n\n  // Recommend a bundle ID based on the username and project slug.\n  let recommendedBundleId: string | undefined;\n  // Attempt to use the android package name first since it's convenient to have them aligned.\n  if (exp.android?.package && validateBundleId(exp.android?.package)) {\n    recommendedBundleId = exp.android?.package;\n  } else {\n    const username = exp.owner ?? (await UserManager.getCurrentUsernameAsync());\n    const possibleId = `com.${username}.${exp.slug}`;\n    if (username && validateBundleId(possibleId)) {\n      recommendedBundleId = possibleId;\n    }\n  }\n\n  log.addNewLineIfNone();\n  log(\n    `${log.chalk.bold(`üìù iOS Bundle Identifier`)} ${log.chalk.dim(\n      learnMore('https://expo.fyi/bundle-identifier')\n    )}`\n  );\n  log.newLine();\n  // Prompt the user for the bundle ID.\n  // Even if the project is using a dynamic config we can still\n  // prompt a better error message, recommend a default value, and help the user\n  // validate their custom bundle ID upfront.\n  const { bundleIdentifier } = await prompt(\n    [\n      {\n        name: 'bundleIdentifier',\n        default: recommendedBundleId,\n        // The Apple helps people know this isn't an EAS feature.\n        message: `What would you like your iOS bundle identifier to be?`,\n        validate: validateBundleId,\n      },\n    ],\n    {\n      nonInteractiveHelp: noBundleIdMessage,\n    }\n  );\n\n  await attemptModification(\n    projectRoot,\n    {\n      ios: { ...(exp.ios || {}), bundleIdentifier },\n    },\n    { ios: { bundleIdentifier } }\n  );\n\n  return bundleIdentifier;\n}\n\nexport async function getOrPromptForPackage(projectRoot: string): Promise<string> {\n  const { exp } = getConfig(projectRoot, { skipSDKVersionRequirement: true });\n\n  const currentPackage = exp.android?.package;\n  if (currentPackage) {\n    if (validatePackage(currentPackage)) {\n      return currentPackage;\n    }\n    log(\n      log.chalk.red(\n        `Invalid format of Android package name. Only alphanumeric characters, '.' and '_' are allowed, and each '.' must be followed by a letter.`\n      )\n    );\n\n    process.exit(1);\n  }\n\n  // Recommend a package name based on the username and project slug.\n  let recommendedPackage: string | undefined;\n  // Attempt to use the ios bundle id first since it's convenient to have them aligned.\n  if (exp.ios?.bundleIdentifier && validatePackage(exp.ios.bundleIdentifier)) {\n    recommendedPackage = exp.ios.bundleIdentifier;\n  } else {\n    const username = exp.owner ?? (await UserManager.getCurrentUsernameAsync());\n    // It's common to use dashes in your node project name, strip them from the suggested package name.\n    const possibleId = `com.${username}.${exp.slug}`.split('-').join('');\n    if (username && validatePackage(possibleId)) {\n      recommendedPackage = possibleId;\n    }\n  }\n\n  log.addNewLineIfNone();\n  log(\n    `${log.chalk.bold(`üìù Android package`)} ${log.chalk.dim(\n      learnMore('https://expo.fyi/android-package')\n    )}`\n  );\n  log.newLine();\n\n  // Prompt the user for the android package.\n  // Even if the project is using a dynamic config we can still\n  // prompt a better error message, recommend a default value, and help the user\n  // validate their custom android package upfront.\n  const { packageName } = await prompt(\n    [\n      {\n        name: 'packageName',\n        default: recommendedPackage,\n        message: `What would you like your Android package name to be?`,\n        validate: validatePackage,\n      },\n    ],\n    {\n      nonInteractiveHelp: noPackageMessage,\n    }\n  );\n\n  await attemptModification(\n    projectRoot,\n    {\n      android: { ...(exp.android || {}), package: packageName },\n    },\n    {\n      android: { package: packageName },\n    }\n  );\n\n  return packageName;\n}\n\nasync function attemptModification(\n  projectRoot: string,\n  edits: Partial<ExpoConfig>,\n  exactEdits: Partial<ExpoConfig>\n): Promise<void> {\n  const modification = await modifyConfigAsync(projectRoot, edits, {\n    skipSDKVersionRequirement: true,\n  });\n  if (modification.type === 'success') {\n    log.newLine();\n  } else {\n    warnAboutConfigAndExit(modification.type, modification.message!, exactEdits);\n  }\n}\n\nfunction logNoConfig() {\n  log(\n    log.chalk.yellow(\n      'No Expo config was found. Please create an Expo config (`app.config.js` or `app.json`) in your project root.'\n    )\n  );\n}\n\nfunction warnAboutConfigAndExit(type: string, message: string, edits: Partial<ExpoConfig>) {\n  log.addNewLineIfNone();\n  if (type === 'warn') {\n    // The project is using a dynamic config, give the user a helpful log and bail out.\n    log(log.chalk.yellow(message));\n  } else {\n    logNoConfig();\n  }\n\n  notifyAboutManualConfigEdits(edits);\n  process.exit(1);\n}\n\nfunction notifyAboutManualConfigEdits(edits: Partial<ExpoConfig>) {\n  log(log.chalk.cyan(`Please add the following to your Expo config, and try again... `));\n  log.newLine();\n  log(JSON.stringify(edits, null, 2));\n  log.newLine();\n}\n"],"file":"ConfigValidation.js"}